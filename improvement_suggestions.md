# ISOP - 改善案と潜在的バグの指摘

## 概要

このドキュメントは、ISOPアプリケーションのソースコードレビューに基づいた改善提案と、潜在的なエラーやバグの可能性をまとめたものです。

---

## 1. 改善提案

### 1.1. 機能に関する提案

#### **① AI対話機能の強化**
現状のAI対話機能は、事前に用意された固定の質問リストを表示するだけで、AIがドキュメント内容を分析して動的に質問を生成していません。これを改善し、真に対話的なAIエージェントにするための提案です。

*   **提案**:
    1.  ユーザーがアップロードした「既存書類」と「新規格内容」の両方をAIに読み込ませる。
    2.  AIに2つの文書の差分や関連性を分析させ、「*新規格の第X条は、既存書類の第Y章に関連しますが、具体的な対応方針を教えてください*」といった、文脈に基づいた具体的な質問を自動生成させる。
    3.  ユーザーがその質問に回答すると、その内容を反映してAIが文書の書き換えを行うようにする。
*   **期待される効果**: ユーザーはAIと対話しながら修正方針を固めることができ、生成されるドキュメントの精度が飛躍的に向上します。

#### **② Word形式（.docx）での差分出力**
現在の差分レポートはマークダウン形式ですが、多くの企業では最終的な納品物としてWord形式が求められます。

*   **提案**: マークダウンの差分レポートに加え、Wordの「変更履歴」機能を使った差分ファイル（.docx）を出力する機能を追加する。
*   **期待される効果**: レポートを確認したユーザーが、そのまま社内レビューや公式文書として活用できるようになり、利便性が大幅に向上します。

#### **③ コスト管理と透明性の向上**
OpenAI APIの利用はコストがかかります。ユーザーが意図せず高額な料金を請求されるリスクを低減します。

*   **提案**:
    *   処理を開始する前に、ドキュメントの文字数に基づいて概算のAPI利用料金を提示する。
    *   品質とコストに応じて、ユーザーがAIモデル（例: 高速なGPT-4o-mini、高精度なGPT-4）を選択できるようにする。
*   **期待される効果**: ユーザーが安心してサービスを利用できるようになり、予算に応じた運用が可能になります。

### 1.2. システムアーキテクチャに関する提案

#### **① 非同期処理の導入によるUIフリーズの解消**
現状では、AI処理中にUIが完全にフリーズしてしまい、ユーザーは処理が終わるまで何もできません。

*   **提案**: ファイル処理やAIへの問い合わせといった時間のかかる処理を、バックグラウンドで実行する非同期タスクに切り替える（例: `threading`や`asyncio`を利用）。
*   **期待される効果**: 処理中もユーザーは他の画面を見たり、別の操作をしたりすることが可能になり、UXが大幅に改善されます。処理のタイムアウトも防げます。

#### **② 設定と対話履歴の永続化**
現在、APIキー設定やAIとの対話履歴は、アプリを再起動するとすべて消えてしまいます。

*   **提案**:
    *   APIキーやDBパスといった設定情報を、`.env`ファイルや設定ファイルに保存し、次回起動時も読み込めるようにする。
    *   対話履歴をローカルの軽量データベース（SQLiteなど）に保存し、過去の対話を確認できるようにする。
*   **期待される効果**: ユーザーが毎回設定を入力する手間がなくなり、過去の作業履歴を後から参照できるようになります。

#### **③ 大規模ファイルへの対応**
現状の実装では、数MB程度のファイルを想定しており、数十MBを超えるような大きなファイルをアップロードするとメモリ不足でクラッシュする可能性があります。

*   **提案**: ファイルを一度にメモリに読み込むのではなく、部分的に読み込んで処理する「ストリーミング処理」を導入する。テキストをチャンク（断片）に分割する際も、よりメモリ効率の良い方法に見直す。
*   **期待される効果**: アプリケーションの安定性が向上し、より大規模で実用的なドキュメントにも対応できるようになります。

---

## 2. 潜在的なエラーやバグ

### **① ページの再読み込みや遷移によるアップロードファイルの消失**
*   **問題**: `app_core/app.py`において、Streamlitのセッション管理の仕組み上、ユーザーがブラウザをリロードしたり、特定の操作（サイドバーでのページ切り替えなど）を行ったりした際に、アップロードしたファイルの情報が失われ、再度アップロードを求められる可能性があります。
*   **影響**: ユーザー体験を著しく損ない、フラストレーションの原因となります。
*   **修正案**: Streamlitの`st.session_state`をより堅牢に使い、ページ間で状態（特にアップロードされたファイルオブジェクト）を確実に引き継ぐロジックを強化する必要があります。

### **② 不十分なエラーハンドリング**
*   **問題**: 多くの箇所で`try...except Exception as e:`という汎用的な例外処理が使われています。これにより、例えば「APIキーが間違っている」場合と「アップロードされたPDFが破損している」場合で、ユーザーには同じ「エラーが発生しました」というメッセージしか表示されません。
*   **影響**: エラーの原因が分からず、ユーザー自身での問題解決が困難になります。
*   **修正案**: OpenAIのAPIエラー、ファイルI/Oエラー、DB接続エラーなど、想定されるエラーごとに個別の`except`ブロックを設け、より具体的で分かりやすいエラーメッセージをユーザーに提示するべきです。

### **③ ドキュメントと実装の不一致**
*   **問題**:
    *   `使用説明書.md`にはAIモデルとして「GPT-5-mini」の記載がありますが、`app_core/app.py`の実装では「gpt-4o-mini」などが選択肢となっています。
    *   `README.md`では「バッチ処理」が主な機能として挙げられていますが、`使用説明書.md`では「現在は1つの書類ずつ処理します」と記載されており、機能の実装状況が不明確です。
*   **影響**: ユーザーに混乱を与え、製品の信頼性を損ないます。
*   **修正案**: ドキュメントを最新のコード実装に合わせて更新し、すべての記述を統一する必要があります。
